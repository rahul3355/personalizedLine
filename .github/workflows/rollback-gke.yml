name: Rollback GKE Deployment

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to rollback (web, worker, or both)'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - web
          - worker
      revision:
        description: 'Revision number to rollback to (leave empty for previous)'
        required: false
        type: string

env:
  PROJECT_ID: personalizedline-prod
  GKE_CLUSTER: personalized-cluster
  GKE_REGION: us-central1
  GKE_NAMESPACE: personalizedline

jobs:
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.PROJECT_ID }}

      - name: Show rollout history
        run: |
          if [ "${{ inputs.service }}" = "web" ] || [ "${{ inputs.service }}" = "both" ]; then
            echo "=== Web Deployment History ==="
            kubectl rollout history deployment/web -n ${{ env.GKE_NAMESPACE }}
          fi

          if [ "${{ inputs.service }}" = "worker" ] || [ "${{ inputs.service }}" = "both" ]; then
            echo "=== Worker Deployment History ==="
            kubectl rollout history deployment/rq-worker -n ${{ env.GKE_NAMESPACE }}
          fi

      - name: Rollback Web
        if: inputs.service == 'web' || inputs.service == 'both'
        run: |
          echo "Rolling back web deployment..."
          if [ -n "${{ inputs.revision }}" ]; then
            kubectl rollout undo deployment/web \
              --to-revision=${{ inputs.revision }} \
              -n ${{ env.GKE_NAMESPACE }}
          else
            kubectl rollout undo deployment/web \
              -n ${{ env.GKE_NAMESPACE }}
          fi

      - name: Rollback Worker
        if: inputs.service == 'worker' || inputs.service == 'both'
        run: |
          echo "Rolling back worker deployment..."
          if [ -n "${{ inputs.revision }}" ]; then
            kubectl rollout undo deployment/rq-worker \
              --to-revision=${{ inputs.revision }} \
              -n ${{ env.GKE_NAMESPACE }}
          else
            kubectl rollout undo deployment/rq-worker \
              -n ${{ env.GKE_NAMESPACE }}
          fi

      - name: Wait for rollback to complete
        run: |
          if [ "${{ inputs.service }}" = "web" ] || [ "${{ inputs.service }}" = "both" ]; then
            echo "Waiting for web rollback..."
            kubectl rollout status deployment/web \
              -n ${{ env.GKE_NAMESPACE }} \
              --timeout=5m
          fi

          if [ "${{ inputs.service }}" = "worker" ] || [ "${{ inputs.service }}" = "both" ]; then
            echo "Waiting for worker rollback..."
            kubectl rollout status deployment/rq-worker \
              -n ${{ env.GKE_NAMESPACE }} \
              --timeout=5m
          fi

      - name: Verify rollback
        run: |
          echo "=== Current Deployment Status ==="
          kubectl get deployments -n ${{ env.GKE_NAMESPACE }}
          echo ""
          kubectl get pods -n ${{ env.GKE_NAMESPACE }}

      - name: Rollback Summary
        if: success()
        run: |
          echo "âœ… Rollback completed successfully!"
          echo "ðŸ”„ Service: ${{ inputs.service }}"
          if [ -n "${{ inputs.revision }}" ]; then
            echo "ðŸ“Œ Revision: ${{ inputs.revision }}"
          else
            echo "ðŸ“Œ Rolled back to previous revision"
          fi
